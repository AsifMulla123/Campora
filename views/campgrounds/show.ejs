<% layout('layouts/boilerplate')%>
<!-- Leaflet CSS (included here so this view works even if layout isn't updated) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-o9N1jXJ3A3m5zfWzY4G1Yrw2snxkpTzjHL6tW3Hc3pA="
  crossorigin=""
/>

<link rel="stylesheet" href="/stylesheets/stars.css">
<style>
  /* quick map sizing for this page */
  #map {
    height: 400px;
    width: 100%;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  /* ensure leaflet container doesn't conflict with bootstrap */
  .leaflet-container {
    font: inherit;
  }
</style>

<div class="row">
    <div class="col-6">
        <% if(campground.images && campground.images.length > 0) { %>
        <div id="campgroundCarousel" class="carousel slide" data-ride="carousel" data-interval="5000">
            <ol class="carousel-indicators">
                <% campground.images.forEach((img, i) => { %>
                <li data-target="#campgroundCarousel" data-slide-to="<%= i %>" class="<%= i === 0 ? 'active' : ''%>"></li>
                <% }) %>
            </ol>
            <div class="carousel-inner">
                <% campground.images.forEach((img, i) => {  %>
                <div class="carousel-item <%= i === 0 ? 'active' : ''%>">
                    <img src="<%= img.url%>" class="d-block w-100" alt="Campground image" style="height: 400px; object-fit: cover;">
                </div>
                <% }) %>
            </div>
            <% if(campground.images.length > 1) {%>
            <a class="carousel-control-prev" href="#campgroundCarousel" role="button" data-slide="prev" style="filter: invert(1);">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#campgroundCarousel" role="button" data-slide="next" style="filter: invert(1);">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
            <% } %>
        </div>
        <% } else { %>
        <div style="height: 400px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
            <p class="text-muted">No images available</p>
        </div>
        <% } %>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title"><%= campground.title%></h5>
                <p class="card-text"><%= campground.description%></p>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item text-muted"><%= campground.location%></li>
                <li class="list-group-item">Submitted by <%= campground.author.username%></li>
                <li class="list-group-item">
                  <% if(campground.price === 'free') { %>
                    Free
                  <% } else { %>
                    $<%= campground.priceAmount%>/night
                  <% } %>
                </li>
            </ul>
            <%  if( currentUser && campground.author && (campground.author.equals(currentUser._id) || currentUser.isAdmin))  {%>
            <div class="card-body">
                <a class="card-link btn btn-info" href="/campgrounds/<%=campground._id%>/edit">Edit</a>
                <form class="d-inline" action="/campgrounds/<%=campground._id%>?_method=DELETE" method="POST">
                    <button class="btn btn-danger">Delete</button>
                </form>
            </div>
            <% } %>
            <div class="card-footer text-muted">
                <% 
                  let displayTime = 'Date unavailable';
                  if (campground.createdAt) {
                    const createdAt = new Date(campground.createdAt);
                    if (!isNaN(createdAt.getTime())) {
                      displayTime = createdAt.toLocaleString('en-IN', { 
                        timeZone: 'Asia/Kolkata',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                      });
                    }
                  }
                %>
                <%= displayTime %>
            </div>
        </div>

    </div>
    <div class="col-6">
        <div id='map'></div>
        
        <div class="mb-3 mt-3">
            <button class="btn btn-primary" onclick="getDirections()">Get Directions</button>
        </div>

        <!-- Booking Section -->
        <% if(currentUser && (!campground.author || !campground.author.equals(currentUser._id))) { %>
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Book This Campground</h5>
            </div>
            <div class="card-body">
                <form action="/bookings/create" method="POST" id="bookingForm">
                    <input type="hidden" name="campgroundId" value="<%= campground._id %>">
                    
                    <div class="mb-3">
                        <label for="checkInDate" class="form-label">Check-In Date</label>
                        <input type="date" class="form-control" id="checkInDate" name="checkInDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="checkOutDate" class="form-label">Check-Out Date</label>
                        <input type="date" class="form-control" id="checkOutDate" name="checkOutDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <p class="mb-1"><strong>Price per night:</strong> 
                            <% if(campground.price === 'free') { %>
                                Free
                            <% } else { %>
                                $<%= campground.priceAmount %>
                            <% } %>
                        </p>
                        <p class="mb-1"><strong>Total nights:</strong> <span id="numberOfNights">0</span></p>
                        <p><strong>Total price:</strong> $<span id="totalPrice">0</span></p>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">Book Now</button>
                </form>
                <div id="availabilityMessage" class="mt-2"></div>
            </div>
        </div>
        <% } %>

        <!-- View Bookings Link for Owner -->
        <% if(currentUser && campground.author && (campground.author.equals(currentUser._id) || currentUser.isAdmin)) { %>
            <a href="/bookings/campground/<%= campground._id %>" class="btn btn-info w-100 mb-3">View Bookings</a>
        <% } %>

        <% if(currentUser){ %>
        <h2>Leave a Review</h2>
        <form action="/campgrounds/<%=campground._id%>/reviews" method="POST" class="mb-3 validated-form" novalidate>
            <fieldset class="starability-basic">
                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked
                    aria-label="No rating." />
                <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                <label for="first-rate1" title="Terrible">1 star</label>
                <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                <label for="first-rate2" title="Not good">2 stars</label>
                <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                <label for="first-rate3" title="Average">3 stars</label>
                <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                <label for="first-rate4" title="Very good">4 stars</label>
                <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                <label for="first-rate5" title="Amazing">5 stars</label>
            </fieldset>
            <div class="mb-3">
                <label class="form-label" for="body">Review Text</label>
                <textarea class="form-control" name="review[body]" id="body" cols="30" rows="3" required></textarea>
                <div class="valid-feedback">
                    Looks good!
                </div>
            </div>
            <button class="btn btn-success">Submit</button>
        </form>
        <% } %>
        <% for(let review of campground.reviews) { %>
        <div class="card mb-3 ">
            <div class="card-body">
                <h5 class="card-title"> <%= review.author.username%></h5>
                <p class="starability-result" data-rating="<%=review.rating%>">
                    Rated: <%= review.rating %> stars
                </p>
                <p class="card-text">Review: <%= review.body %></p>
                <%  if( currentUser && review.author && (review.author.equals(currentUser._id) || currentUser.isAdmin))  {%>
                <form action="/campgrounds/<%=campground._id%>/reviews/<%=review._id%>?_method=DELETE" method="POST">
                    <button class="btn btn-sm btn-danger">Delete</button>
                </form>
                <% } %>
            </div>
        </div>
        <% } %>
    </div>
</div>

<!-- Pass server-side campground into JS safely -->
<script>window.campground = <%- JSON.stringify(campground) %>;</script>

<script>
  function getDirections() {
    // Get campground coordinates
    const lat = window.campground.geometry.coordinates[1];
    const lng = window.campground.geometry.coordinates[0];
    const title = window.campground.title;
    
    // Open Google Maps with directions
    // This will open Google Maps with the destination set to the campground
    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${title}`;
    window.open(mapsUrl, '_blank');
  }

  // Booking form calculations
  document.addEventListener('DOMContentLoaded', function() {
    const checkInInput = document.getElementById('checkInDate');
    const checkOutInput = document.getElementById('checkOutDate');
    const pricePerNight = window.campground.priceAmount || 0;

    function updateBookingPrice() {
      const checkIn = new Date(checkInInput.value);
      const checkOut = new Date(checkOutInput.value);
      
      if (checkIn && checkOut && checkOut > checkIn) {
        const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
        const totalPrice = nights * pricePerNight;
        
        document.getElementById('numberOfNights').textContent = nights;
        document.getElementById('totalPrice').textContent = totalPrice;
      } else {
        document.getElementById('numberOfNights').textContent = '0';
        document.getElementById('totalPrice').textContent = '0';
      }
    }

    if (checkInInput) {
      checkInInput.addEventListener('change', updateBookingPrice);
    }
    if (checkOutInput) {
      checkOutInput.addEventListener('change', updateBookingPrice);
    }
  });
</script>

<script src="/javascripts/showPageMap.js"></script>
